# 環境

![環境](images/environment.png)

あなたのアプリケーションは、恐らく多くのソフトウェアに依存することにな
るでしょう。
少なくともFlaskパッケージに依存していない場合、あなたは誤った本を読んで
いる可能性があります。
アプリケーションの*環境*とは、それを実行するのに必要となるファイルの事
です。
幸運なことに、環境を構築するための簡単な方法がいくつかあります。

## virtualenvで環境を管理する

virtualenvはアプリケーションを分離された**仮想環境**で動作させるための
ツールです。
仮想環境とはアプリケーションが依存するソフトウェアを格納したディレクト
リの事です。
また、仮想環境内では環境変数が変更されます。
virtualenvではパッケージをシステムディレクトリ、またはユーザーディレク
トリに配置するのではなく、アプリケーション専用の分離されたディレクトリ
に配置します。
これにより、プロジェクト毎に利用するPythonバイナリ、依存ライブラリを簡
単に切り替えることができるようになります。

また、virtualenvはプロジェクト毎に異なるバージョンのパッケージのを使い
分ける事ができます。
あなたが古いシステムで動作するプロジェクトを抱えている場合はこの特徴は
重要です。

一般的にvirtualenvを利用するときには、少なくとも一つのPythonパッケージ
がシステムグローバル環境にインストールされていると思います。
これも一つのvirtualenv環境ですので、ここにpipを利用して`virtualenv`パッ
ケージをインストールすることが出来ます。

システムにvirtualenvパッケージがインストールされると、仮想環境を作成で
きるようになります。
プロジェクトディレクトリに移動し、`virtualenv`コマンドを実行して下さい。
引き数には作成する仮想環境の対象ディレクトリを指定します。
以下に実行例を示します。

~~~ {language=command}
$ virtualenv venv
New python executable in venv/bin/python
Installing Setuptools...........[...].....done.
Installing Pip..................[...].....done.
~~~

これで新しい仮想環境が作成されました。

新しい仮想環境を有効にする為には、仮想環境内に配置されている
*bin/activate* スクリプトを読み込む必要があります。

~~~ {language=command}
$ which python
/usr/local/bin/python
$ source venv/bin/activate
(venv)$ which python
/Users/robert/Code/myapp/venv/bin/python
~~~~

*bin/activate*スクリプトはシェル環境変数を変更することで、グローバル環
 境の代わりに新しい仮想環境を指し示すようになります。
スクリプトを読み込むと、上記のような結果が得られると思います。
仮想環境を有効化すると、`python`コマンドが仮想環境内のバイナリを参照す
るようになります。
ここでpipコマンドを利用すると、システムグローバルではなく仮想環境内に依
存パッケージがインストールされます。

シェルプロンプトも変更されている事に気がついたでしょうか。
virtualenvはシェルプロンプトに現在有効になっている仮想環境の名前を表示
します。
`deactivate`コマンドを実行することで仮想環境を無効化できます。

~~~ {language=command}
(venv)$ deactivate
$
~~~

### virtualenvwrapper

[virtualenvwrapper](http://virtualenvwrapper.readthedocs.org/en/latest/)
はvirtualenv環境を管理するためのパッケージです。
ツールについて言及する為にvirtualenvの基礎について説明しましたが、
virtualenvをそのまま利用するよりも、こちらを推奨します。

仮想環境をプロジェクトディレクトリに作成すると、ソースコードレポジトリがごっちゃになってしまう事があります。
仮想環境のディレクトリは有効にする際に必要なものなのでバージョン管理の必要はありません。
そこで、virtualenvwrapperの出番です。
このパッケージは仮想環境を特定のディレクトリ(通常は ~/.virtualenvs/)で
管理します。

**警告**
virtualenvwrapperをインストールする前に全ての仮想環境を無効化してください。

`virtualenv`コマンドの代わりに`mkvirtualenv`コマンドを実行して環境を作
成します。

~~~ {language=command}
$ mkvirtualenv rocket
New python executable in rocket/bin/python
Installing setuptools...........[...].....done.
Installing pip..................[...].....done.
(rocket)$
~~~~

`mkvirtualenv`コマンドは特定の仮想環境フォルダ(~/.virtualenvs/)に環境を
作成し、有効化します。
先ほどの`virtualenv`と同様に、`python`や`pip`コマンドは仮想環境内のコマ
ンドに切り替わります。
仮想環境を有効化するには、`workon [環境名]`を実行します。
無効化するには先ほどと同様に`deactivate`コマンドを実行します。

### 依存関係を維持する
プロジェクトが大きくなるにつれて、依存関係も増えていることを経験したこ
とがあるでしょう。
Flaskアプリケーションを実行するために数十個の依存ライブラリが必要になる
ことも珍しくありません。
これらの依存関係を管理する最も単純な方法はテキストファイルに記述するこ
とです。
pipはインストール済みのパッケージをテキストファイルで出力できます。
新しい環境にこれらのパッケージをインストールする際には、このテキストファ
イルを読み込むだけで済みます。

#### pip freeze
*requirements.txt*はFlaskアプリケーションの実行に必要な全てのパッケージ
 が記述されているテキストファイルです。
以下に、このファイルの生成方法と、新しい環境テキストファイルから依存パッ
ケージをインストールする例を示します。

~~~ {language=command}
(rocket)$ pip freeze > requirements.txt

$ workon fresh-env
(fresh-env)$ pip install -r requirements.txt
[...]
Successfully installed flask Werkzeug Jinja2 itsdangerous markupsafe
Cleaning up...
(fresh-env)$
~~~

### 依存パッケージの管理
プロジェクトが大きくなると、`pip freeze`の出力にアプリケーションの実行
には必要の無い依存パッケージが含まれてしまう事があるかもしれません。
開発時のみに利用するパッケージなどがそうです。`pip freeze`は実行時に必
要なパッケージと開発時に必要なパッケージを区別せず、単純に現在インストー
ルされているパッケージを出力します。
従って、ある程度は手動で依存関係をメンテナンスする必要があります。
例えば、*require\_run.txt*というファイルと*require\_dev.txt*というファ
イルに分けて依存パッケージを管理しても良いでしょう。

## バージョン管理
なんらかのバージョン管理システムを使ってください。
私ならGitを推奨します。
私の知る限り、Gitは近年最も多くのプロジェクトで採用されています。
バージョン管理を行うと、やり直しのできないミスを心配すること無く、コードの削除などの操作を行うことができます。
コードを削除してもrevertして元に戻せるので、大量のコメントアウトされた
コードブロックに悩む必要がなくなります。
さらに、GitHubやBitbucket、あるいは自前のGitoliteサーバーなどに完全なバッ
クアップを持つことができます。

### バージョン管理からの除外
例外的にバージョン管理を行わない方が良いファイルもあります。
雑多なファイルや秘密のファイルなどです。
コンパイル済みの*.pyc*ファイルやvirtualenv環境(virtualenvwrapperを利用
していない場合)などは雑多なファイルであり、バージョン管理の必要はありま
せん。
*.pyc*ファイルは*.py*ファイルから生成物であり、virtualenv環境は
 *requirements.txt*ファイルから生成できるからです。

APIキーやアプリケーションの秘密鍵、データーベース接続のパスワードは、秘
密のファイルです。
これらのファイルが人前に晒されると、重大なセキュリティ上の脅威となりま
すので秘密のファイルをバージョンコントロール下に置いてはいけません。

**注記**
私はいつもプラーベートレポジトリであってもいつか公開される可能性がある
と仮定してセキュリティポリシーを策定します。
これは秘密が流出するようなセキュリティホールを無くすことは出来ないと
いう前提に基づいています。そのような事は誰も保証できません。
この様に、隠すことに依存したセキュリティポリシーは悪手であるとされて
います。

Gitを利用する場合、レポジトリに*.gitignore*と呼ばれるファイルを作成する
事で、ワイルドカードにマッチしたファイルをレポジトリから除外することが
出来ます。
まずは以下のファイルを除外することを推奨します。

~~~
*.pyc
instance/
~~~~

*instance/*フォルダは、秘密を含む設定を格納し、より安全にアプリケーショ
 ンを動作させる為に利用します。
これについては後ほど説明します。

**注記**

*.gitignore*の詳細はこちらを参照して下さい。

<http://git-scm.com/docs/gitignore>

## デバッグ

### デバッグモード
Flaskはデバッグモードと呼ばれる機能を持っています。
開発環境で`debug = True`と設定するとデバッグモードが有効になります。
デバッグモードではコードの変更を検知して自動的に再読み込みを行い、エラー
が発生した場合はスタックトレースを出力し、インタラクティブコンソールを
利用できます。

**警告**

本番環境でデバッグモードを有効にしないよう注意して下さい。
インタラクティブコンソールは任意のコードを実行できるため、本番環境では重大なセキュリティホールとなってしまいます。

### Flask-DebugToolbar
[Flask-DebugToolbar](http://flask-debugtoolbar.readthedocs.org/en/latest/)
は、アプリケーションの問題をデバッグするためのもうひとつのツールです。
デバッグモードでこれを利用すると、アプリケーションにサイドバーが設置さ
れます。
サイドバーにはSQLクエリやログ、バージョン、テンプレート、設定などその他
愉快な情報が表示され、問題を追跡し易くなります。

**注記**

- 詳しくはこちらのクイックスタートを読んでください。
  <http://flask.pocoo.org/docs/quickstart/#debug-mode>
- こちらに他のデバッガを利用したエラー処理とロギングについての情報があります。
  <http://flask.pocoo.org/docs/errorhandling>

## まとめ
- アプリケーションの依存関係を維持するためにvirtualenvを利用して下さい。
- 仮想環境を維持するためにvirtualenvwrapperを利用して下さい。
- 依存関係はテキストファイルで管理して下さい。
- バージョン管理システムはGitを推奨します。
- バージョン管理システムから秘密のファイルを除外するために.gitignoreを利用して下さい。
- デバッグモードで問題解決に必要な情報を得ることが出来ます。
- Flask-DebugToolbar拡張はもっと詳細な情報を得ることが出来ます。

